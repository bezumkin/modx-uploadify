/*
 UploadiFive 1.1.2
 Copyright (c) 2012 Reactive Apps, Ronnie Garcia
 Released under the UploadiFive Standard License <http://www.uploadify.com/uploadifive-standard-license>
 */
(function(e){var t={init:function(n){return this.each(function(){var r=e(this);r.data("uploadifive",{inputs:{},inputCount:0,fileID:0,queue:{count:0,selected:0,replaced:0,errors:0,queued:0,cancelled:0},uploads:{current:0,attempts:0,successful:0,errors:0,count:0}});var s=r.data("uploadifive");var o=s.settings=e.extend({auto:true,buttonClass:false,buttonText:"Select Files",checkScript:false,dnd:true,dropTarget:false,fileObjName:"Filedata",fileSizeLimit:0,fileType:false,formData:{},height:30,itemTemplate:false,method:"post",multi:true,overrideEvents:[],queueID:false,queueSizeLimit:0,removeCompleted:false,simUploadLimit:0,truncateLength:0,uploadLimit:0,uploadScript:"uploadifive.php",width:100},n);if(isNaN(o.fileSizeLimit)){var u=parseInt(o.fileSizeLimit)*1.024;if(o.fileSizeLimit.indexOf("KB")>-1){o.fileSizeLimit=u*1e3}else if(o.fileSizeLimit.indexOf("MB")>-1){o.fileSizeLimit=u*1e6}else if(o.fileSizeLimit.indexOf("GB")>-1){o.fileSizeLimit=u*1e9}}else{o.fileSizeLimit=o.fileSizeLimit*1024}s.inputTemplate=e('<input type="file">').css({"font-size":o.height+"px",opacity:0,position:"absolute",right:"-3px",top:"-3px","z-index":999});s.createInput=function(){var n=s.inputTemplate.clone();var i=n.name="input"+s.inputCount++;if(o.multi){n.attr("multiple",true)}n.bind("change",function(){s.queue.selected=0;s.queue.replaced=0;s.queue.errors=0;s.queue.queued=0;var n=this.files.length;s.queue.selected=n;if(s.queue.count+n>o.queueSizeLimit&&o.queueSizeLimit!==0){if(e.inArray("onError",o.overrideEvents)<0){alert("The maximum number of queue items has been reached ("+o.queueSizeLimit+").  Please select fewer files.")}if(typeof o.onError==="function"){o.onError.call(r,"QUEUE_LIMIT_EXCEEDED")}}else{for(var u=0;u<n;u++){file=this.files[u];s.addQueueItem(file)}s.inputs[i]=this;s.createInput()}if(o.auto){t.upload.call(r)}if(typeof o.onSelect==="function"){o.onSelect.call(r,s.queue)}});if(s.currentInput){s.currentInput.hide()}s.button.append(n);s.currentInput=n};s.destroyInput=function(t){e(s.inputs[t]).remove();delete s.inputs[t];s.inputCount--};s.drop=function(n){s.queue.selected=0;s.queue.replaced=0;s.queue.errors=0;s.queue.queued=0;var i=n.dataTransfer;var u=i.name="input"+s.inputCount++;var a=i.files.length;s.queue.selected=a;if(s.queue.count+a>o.queueSizeLimit&&o.queueSizeLimit!==0){if(e.inArray("onError",o.overrideEvents)<0){alert("The maximum number of queue items has been reached ("+o.queueSizeLimit+").  Please select fewer files.")}if(typeof o.onError==="function"){o.onError.call(r,"QUEUE_LIMIT_EXCEEDED")}}else{for(var f=0;f<a;f++){file=i.files[f];s.addQueueItem(file)}s.inputs[u]=i}if(o.auto){t.upload.call(r)}if(typeof o.onDrop==="function"){o.onDrop.call(r,i.files,i.files.length)}n.preventDefault();n.stopPropagation();e(this).removeClass("hover")};s.fileExistsInQueue=function(e){for(var t in s.inputs){input=s.inputs[t];limit=input.files.length;for(var n=0;n<limit;n++){existingFile=input.files[n];if(existingFile.name==e.name&&!existingFile.complete){return true}}}return false};s.removeExistingFile=function(e){for(var n in s.inputs){input=s.inputs[n];limit=input.files.length;for(var i=0;i<limit;i++){existingFile=input.files[i];if(existingFile.name==e.name&&!existingFile.complete){s.queue.replaced++;t.cancel.call(r,existingFile,true)}}}};if(o.itemTemplate==false){s.queueItem=e('<div class="uploadifive-queue-item">                        <a class="close" href="#">X</a>                        <div><span class="filename"></span><span class="fileinfo"></span></div>                        <div class="progress">                            <div class="progress-bar"></div>                        </div>                    </div>')}else{s.queueItem=e(o.itemTemplate)}s.addQueueItem=function(n){if(e.inArray("onAddQueueItem",o.overrideEvents)<0){s.removeExistingFile(n);n.queueItem=s.queueItem.clone();n.queueItem.attr("id",o.id+"-file-"+s.fileID++);n.queueItem.find(".close").bind("click",function(){t.cancel.call(r,n);return false});var i=n.name;if(i.length>o.truncateLength&&o.truncateLength!=0){i=i.substring(0,o.truncateLength)+"..."}n.queueItem.find(".filename").html(i);n.queueItem.data("file",n);s.queueEl.append(n.queueItem)}if(typeof o.onAddQueueItem==="function"){o.onAddQueueItem.call(r,n)}if(o.fileType){if(e.isArray(o.fileType)){var u=false;for(var a=0;a<o.fileType.length;a++){if(n.type.indexOf(o.fileType[a])>-1){u=true}}if(!u){s.error("FORBIDDEN_FILE_TYPE",n)}}else{if(n.type.indexOf(o.fileType)<0){s.error("FORBIDDEN_FILE_TYPE",n)}}}if(n.size>o.fileSizeLimit&&o.fileSizeLimit!=0){s.error("FILE_SIZE_LIMIT_EXCEEDED",n)}else{s.queue.queued++;s.queue.count++}};s.removeQueueItem=function(t,n,r){if(!r)r=0;var i=n?0:500;if(t.queueItem){if(t.queueItem.find(".fileinfo").html()!=" - Completed"){t.queueItem.find(".fileinfo").html(" - Cancelled")}t.queueItem.find(".progress-bar").width(0);t.queueItem.delay(r).fadeOut(i,function(){e(this).remove()});delete t.queueItem;s.queue.count--}};s.filesToUpload=function(){var e=0;for(var t in s.inputs){input=s.inputs[t];limit=input.files.length;for(var n=0;n<limit;n++){file=input.files[n];if(!file.skip&&!file.complete){e++}}}return e};s.checkExists=function(n){if(e.inArray("onCheck",o.overrideEvents)<0){e.ajaxSetup({async:false});var i=e.extend(o.formData,{filename:n.name});e.post(o.checkScript,i,function(e){n.exists=parseInt(e)});if(n.exists){if(!confirm("A file named "+n.name+" already exists in the upload folder.\nWould you like to replace it?")){t.cancel.call(r,n);return true}}}if(typeof o.onCheck==="function"){o.onCheck.call(r,n,n.exists)}return false};s.uploadFile=function(t,n){if(!t.skip&&!t.complete&&!t.uploading){t.uploading=true;s.uploads.current++;s.uploads.attempted++;xhr=t.xhr=new XMLHttpRequest;if(typeof FormData==="function"||typeof FormData==="object"){var u=new FormData;u.append(o.fileObjName,t);for(i in o.formData){u.append(i,o.formData[i])}xhr.open(o.method,o.uploadScript,true);xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){s.progress(e,t)}},false);xhr.addEventListener("load",function(e){if(this.readyState==4){t.uploading=false;if(this.status==200){if(t.xhr.responseText!=="Invalid file type."){s.uploadComplete(e,t,n)}else{s.error(t.xhr.responseText,t,n)}}else if(this.status==404){s.error("404_FILE_NOT_FOUND",t,n)}else if(this.status==403){s.error("403_FORBIDDEN",t,uploadAll)}else{s.error("Unknown Error",t,n)}}});xhr.send(u)}else{var a=new FileReader;a.onload=function(i){var u="-------------------------"+(new Date).getTime(),a="--",f="\r\n",l="";l+=a+u+f;l+='Content-Disposition: form-data; name="'+o.fileObjName+'"';if(t.name){l+='; filename="'+t.name+'"'}l+=f;l+="Content-Type: application/octet-stream"+f+f;l+=i.target.result+f;for(key in o.formData){l+=a+u+f;l+='Content-Disposition: form-data; name="'+key+'"'+f+f;l+=o.formData[key]+f}l+=a+u+a+f;xhr.upload.addEventListener("progress",function(e){s.progress(e,t)},false);xhr.addEventListener("load",function(e){t.uploading=false;var r=this.status;if(r==404){s.error("404_FILE_NOT_FOUND",t,n)}else{if(t.xhr.responseText!="Invalid file type."){s.uploadComplete(e,t,n)}else{s.error(t.xhr.responseText,t,n)}}},false);var c=o.uploadScript;if(o.method=="get"){var h=e(o.formData).param();c+=h}xhr.open(o.method,o.uploadScript,true);xhr.setRequestHeader("Content-Type","multipart/form-data; boundary="+u);if(typeof o.onUploadFile==="function"){o.onUploadFile.call(r,t)}xhr.sendAsBinary(l)};a.readAsBinaryString(t)}}};s.progress=function(t,n){if(e.inArray("onProgress",o.overrideEvents)<0){if(t.lengthComputable){var i=Math.round(t.loaded/t.total*100)}n.queueItem.find(".fileinfo").html(" - "+i+"%");n.queueItem.find(".progress-bar").css("width",i+"%")}if(typeof o.onProgress==="function"){o.onProgress.call(r,n,t)}};s.error=function(n,i,u){if(e.inArray("onError",o.overrideEvents)<0){switch(n){case"404_FILE_NOT_FOUND":errorMsg="404 Error";break;case"403_FORBIDDEN":errorMsg="403 Forbidden";break;case"FORBIDDEN_FILE_TYPE":errorMsg="Forbidden File Type";break;case"FILE_SIZE_LIMIT_EXCEEDED":errorMsg="File Too Large";break;default:errorMsg="Unknown Error";break}i.queueItem.addClass("error").find(".fileinfo").html(" - "+errorMsg);i.queueItem.find(".progress").remove()}if(typeof o.onError==="function"){o.onError.call(r,n,i)}i.skip=true;if(n=="404_FILE_NOT_FOUND"){s.uploads.errors++}else{s.queue.errors++}if(u){t.upload.call(r,null,true)}};s.uploadComplete=function(n,i,u){if(e.inArray("onUploadComplete",o.overrideEvents)<0){i.queueItem.find(".progress-bar").css("width","100%");i.queueItem.find(".fileinfo").html(" - Completed");i.queueItem.find(".progress").slideUp(250);i.queueItem.addClass("complete")}if(typeof o.onUploadComplete==="function"){o.onUploadComplete.call(r,i,i.xhr.responseText)}if(o.removeCompleted){setTimeout(function(){t.cancel.call(r,i)},3e3)}i.complete=true;s.uploads.successful++;s.uploads.count++;s.uploads.current--;delete i.xhr;if(u){t.upload.call(r,null,true)}};s.queueComplete=function(){if(typeof o.onQueueComplete==="function"){o.onQueueComplete.call(r,s.uploads)}};if(window.File&&window.FileList&&window.Blob&&(window.FileReader||window.FormData)){o.id="uploadifive-"+r.attr("id");s.button=e('<div id="'+o.id+'" class="uploadifive-button">'+o.buttonText+"</div>");if(o.buttonClass)s.button.addClass(o.buttonClass);s.button.css({height:o.height,"line-height":o.height+"px",overflow:"hidden",position:"relative","text-align":"center",width:o.width});r.before(s.button).appendTo(s.button).hide();s.createInput.call(r);if(!o.queueID){o.queueID=o.id+"-queue";s.queueEl=e('<div id="'+o.queueID+'" class="uploadifive-queue" />');s.button.after(s.queueEl)}else{s.queueEl=e("#"+o.queueID)}if(o.dnd){var a=o.dropTarget?e(o.dropTarget):s.queueEl.get(0);a.addEventListener("dragleave",function(t){t.preventDefault();t.stopPropagation();e(this).removeClass("hover")},false);a.addEventListener("dragenter",function(t){t.preventDefault();t.stopPropagation();e(this).addClass("hover")},false);a.addEventListener("dragover",function(e){e.preventDefault();e.stopPropagation()},false);a.addEventListener("drop",s.drop,false)}if(!XMLHttpRequest.prototype.sendAsBinary){XMLHttpRequest.prototype.sendAsBinary=function(e){function t(e){return e.charCodeAt(0)&255}var n=Array.prototype.map.call(e,t);var r=new Uint8Array(n);this.send(r.buffer)}}if(typeof o.onInit==="function"){o.onInit.call(r)}}else{if(typeof o.onFallback==="function"){o.onFallback.call(r)}return false}})},debug:function(){return this.each(function(){console.log(e(this).data("uploadifive"))})},clearQueue:function(){this.each(function(){var n=e(this),r=n.data("uploadifive"),s=r.settings;for(var o in r.inputs){input=r.inputs[o];limit=input.files.length;for(i=0;i<limit;i++){file=input.files[i];t.cancel.call(n,file)}}if(typeof s.onClearQueue==="function"){s.onClearQueue.call(n,e("#"+r.settings.queueID))}})},cancel:function(n,r){this.each(function(){var i=e(this),s=i.data("uploadifive"),o=s.settings;if(typeof n==="string"){if(!isNaN(n)){fileID="uploadifive-"+e(this).attr("id")+"-file-"+n}n=e("#"+fileID).data("file")}n.skip=true;s.filesCancelled++;if(n.uploading){s.uploads.current--;n.uploading=false;n.xhr.abort();delete n.xhr;t.upload.call(i)}if(e.inArray("onCancel",o.overrideEvents)<0){s.removeQueueItem(n,r)}if(typeof o.onCancel==="function"){o.onCancel.call(i,n)}})},upload:function(t,n){this.each(function(){var r=e(this),i=r.data("uploadifive"),s=i.settings;if(t){i.uploadFile.call(r,t)}else{if(i.uploads.count+i.uploads.current<s.uploadLimit||s.uploadLimit==0){if(!n){i.uploads.attempted=0;i.uploads.successsful=0;i.uploads.errors=0;var o=i.filesToUpload();if(typeof s.onUpload==="function"){s.onUpload.call(r,o)}}e("#"+s.queueID).find(".uploadifive-queue-item").not(".error, .complete").each(function(){_file=e(this).data("file");if(i.uploads.current>=s.simUploadLimit&&s.simUploadLimit!==0||i.uploads.current>=s.uploadLimit&&s.uploadLimit!==0||i.uploads.count>=s.uploadLimit&&s.uploadLimit!==0){return false}if(s.checkScript){_file.checking=true;skipFile=i.checkExists(_file);_file.checking=false;if(!skipFile){i.uploadFile(_file,true)}}else{i.uploadFile(_file,true)}});if(e("#"+s.queueID).find(".uploadifive-queue-item").not(".error, .complete").size()==0){i.queueComplete()}}else{if(i.uploads.current==0){if(e.inArray("onError",s.overrideEvents)<0){if(i.filesToUpload()>0&&s.uploadLimit!=0){alert("The maximum upload limit has been reached.")}}if(typeof s.onError==="function"){s.onError.call(r,"UPLOAD_LIMIT_EXCEEDED",i.filesToUpload())}}}}})},destroy:function(){this.each(function(){var n=e(this),r=n.data("uploadifive"),i=r.settings;t.clearQueue.call(n);if(!i.queueID)e("#"+i.queueID).remove();n.siblings("input").remove();n.show().insertBefore(r.button);r.button.remove();if(typeof i.onDestroy==="function"){i.onDestroy.call(n)}})}};e.fn.uploadifive=function(n){if(t[n]){return t[n].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof n==="object"||!n){return t.init.apply(this,arguments)}else{e.error("The method "+n+" does not exist in $.uploadify")}}})(jQuery)